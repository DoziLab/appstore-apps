#cloud-config
package_update: true
package_upgrade: false

packages:
  - libpam-pwquality
  - python3
  - cloud-guest-utils

# Ensure root partition/filesystem grows when booting from larger volume
growpart:
  mode: auto
  devices: ["/"]
  ignore_growroot_disabled: false

resize_rootfs: true

write_files:
  - path: /usr/local/bin/dozilab-multiuser-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      LOG="/var/log/dozilab-multiuser.log"
      MARK_DIR="/var/lib/dozilab"
      READY_FILE="${MARK_DIR}/ready"
      FAIL_FILE="${MARK_DIR}/failed"

      STACK_LABEL="__STACK_LABEL__"

      # IMPORTANT: must be valid JSON (double quotes). Keep single quotes around JSON to prevent $ expansion.
      STUDENTS_JSON='__STUDENTS_JSON__'
      FORCE="__FORCE_CHANGE__"
      WORKDIR="__WORKDIR__"

      PW_MIN_LENGTH="__PW_MIN_LENGTH__"
      PW_REQUIRE_DIGIT="__PW_REQUIRE_DIGIT__"
      PW_REQUIRE_UPPER="__PW_REQUIRE_UPPER__"
      PW_REQUIRE_SPECIAL="__PW_REQUIRE_SPECIAL__"

      mkdir -p "$MARK_DIR"
      echo "multiuser setup started $(date -Is)" > "$LOG"

      on_fail() {
        rc=$?
        msg="DOZILAB_FAILED stack=${STACK_LABEL} rc=${rc} time=$(date -Is)"
        echo "$msg" | tee -a "$LOG" | tee /dev/console > "$FAIL_FILE"
        chmod 644 "$FAIL_FILE" || true
        exit "$rc"
      }
      trap on_fail ERR

      to_bool() {
        local v="${1:-}"
        v="$(echo "$v" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"
        [[ "$v" == "1" || "$v" == "true" || "$v" == "yes" || "$v" == "on" ]]
      }

      # --- Build deterministic pwquality options from Heat params ---
      DCREDIT=0
      UCREDIT=0
      OCREDIT=0
      if to_bool "$PW_REQUIRE_DIGIT"; then DCREDIT=-1; fi
      if to_bool "$PW_REQUIRE_UPPER"; then UCREDIT=-1; fi
      if to_bool "$PW_REQUIRE_SPECIAL"; then OCREDIT=-1; fi
      if ! [[ "$PW_MIN_LENGTH" =~ ^[0-9]+$ ]]; then PW_MIN_LENGTH=12; fi

      # Enforce exactly what the UI exposes (no dict/diff surprise checks)
      # NOTE: this affects password setting (chpasswd) AND interactive passwd.
      PWQ_OPTS="retry=3 enforce_for_root minlen=${PW_MIN_LENGTH} dcredit=${DCREDIT} ucredit=${UCREDIT} ocredit=${OCREDIT} dictcheck=0 usercheck=0 gecoscheck=0 difok=0 maxrepeat=0 minclass=0"

      # Keep pwquality.conf consistent for debugging/inspection (PAM line is the source of truth)
      cat >/etc/security/pwquality.conf <<EOF
      # Managed by DoziLab (cloud-init). NOTE: PAM options override this file.
      minlen = ${PW_MIN_LENGTH}
      dcredit = ${DCREDIT}
      ucredit = ${UCREDIT}
      ocredit = ${OCREDIT}
      dictcheck = 0
      usercheck = 0
      gecoscheck = 0
      difok = 0
      maxrepeat = 0
      minclass = 0
      EOF

      # --- Enforce our exact policy in PAM (source of truth) ---
      PAM_FILE="/etc/pam.d/common-password"

      if grep -qE '^\s*password\s+requisite\s+pam_pwquality\.so' "$PAM_FILE"; then
        # Replace existing pwquality line
        sed -i -E "s|^\s*password\s+requisite\s+pam_pwquality\.so.*$|password requisite pam_pwquality.so ${PWQ_OPTS}|" "$PAM_FILE"
      else
        # Insert before pam_unix
        sed -i -E "/^\s*password\s+.*pam_unix\.so/ i password requisite pam_pwquality.so ${PWQ_OPTS}" "$PAM_FILE"
      fi

      # SSH: enable password login (students use passwords)
      cat >/etc/ssh/sshd_config.d/99-dozilab-multiuser.conf <<'EOF'
      PasswordAuthentication yes
      KbdInteractiveAuthentication yes
      ChallengeResponseAuthentication yes
      UsePAM yes
      PermitRootLogin no
      EOF

      export STUDENTS_JSON FORCE WORKDIR

      # Create students (hard fail if any user cannot be created or password cannot be set)
      python3 - <<'PY'
      import json, os, re, sys, subprocess

      students_json = os.environ.get("STUDENTS_JSON", "")
      force = str(os.environ.get("FORCE", "true")).lower() in ("1","true","yes","on")
      workdir = os.environ.get("WORKDIR","work")

      try:
          data = json.loads(students_json)
      except Exception as e:
          sys.exit(f"students JSON invalid: {e}. Must be like {{\"alice\":\"pw\"}} (double quotes). Got: {students_json!r}")

      if not isinstance(data, dict) or not data:
          sys.exit("students must be a non-empty JSON object")

      rx = re.compile(r"^[a-z_][a-z0-9_-]{0,31}$")

      def run(cmd, **kw):
          subprocess.run(cmd, check=True, **kw)

      # Validate all upfront so we don't half-configure
      for u, p in data.items():
          if not isinstance(u, str) or not rx.match(u):
              sys.exit(f"Invalid username: {u!r}")
          if not isinstance(p, str) or len(p) == 0:
              sys.exit(f"Empty password for {u}")

      created = []

      for u, p in data.items():
          if subprocess.run(["id", u], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL).returncode != 0:
              run(["useradd", "-m", "-s", "/bin/bash", u])

          # This MUST succeed, otherwise we fail the whole setup
          run(["chpasswd"], input=f"{u}:{p}\n", text=True)

          if force:
              subprocess.run(["chage", "-d", "0", u], check=False)

          run(["chmod", "700", f"/home/{u}"])
          run(["mkdir", "-p", f"/home/{u}/{workdir}"])
          run(["chown", "-R", f"{u}:{u}", f"/home/{u}/{workdir}"])
          run(["chmod", "700", f"/home/{u}/{workdir}"])

          profile = f"/home/{u}/.profile"
          line = f'cd "$HOME/{workdir}"\n'
          try:
              txt = open(profile, "r", encoding="utf-8", errors="ignore").read()
          except FileNotFoundError:
              txt = ""
          if f'cd "$HOME/{workdir}"' not in txt:
              with open(profile, "a", encoding="utf-8") as f:
                  f.write(line)
          run(["chown", f"{u}:{u}", profile])

          created.append(u)

      # Restrict SSH users: ubuntu (admin key) + created students only
      allow = "AllowUsers ubuntu " + " ".join(sorted(created)) + "\n"
      with open("/etc/ssh/sshd_config.d/98-dozilab-allowusers.conf", "w", encoding="utf-8") as f:
          f.write(allow)

      print("created users:", ", ".join(created))
      PY

      # Restart sshd; if this fails, trap will mark FAILED
      systemctl restart ssh || service ssh restart

      echo "multiuser setup finished $(date -Is)" >> "$LOG"

      # READY marker (ONLY here = success)
      msg="DOZILAB_READY stack=${STACK_LABEL} time=$(date -Is)"
      echo "$msg" | tee -a "$LOG" | tee /dev/console > "$READY_FILE"
      chmod 644 "$READY_FILE"

runcmd:
  - [ bash, -lc, "/usr/local/bin/dozilab-multiuser-setup.sh" ]

final_message: "DoziLab multi-user VM: cloud-init finished"
