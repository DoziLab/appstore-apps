#cloud-config
package_update: true
package_upgrade: false

packages:
  - libpam-pwquality
  - python3

write_files:
  - path: /usr/local/bin/dozilab-multiuser-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      LOG="/var/log/dozilab-multiuser.log"
      MARK_FILE="/var/lib/dozilab/ready"
      STACK_LABEL="__STACK_LABEL__"

      STUDENTS_JSON='__STUDENTS_JSON__'
      FORCE="__FORCE_CHANGE__"
      WORKDIR="__WORKDIR__"

      PW_MIN_LENGTH="__PW_MIN_LENGTH__"
      PW_REQUIRE_DIGIT="__PW_REQUIRE_DIGIT__"
      PW_REQUIRE_UPPER="__PW_REQUIRE_UPPER__"
      PW_REQUIRE_SPECIAL="__PW_REQUIRE_SPECIAL__"

      export STUDENTS_JSON FORCE WORKDIR
      export PW_MIN_LENGTH PW_REQUIRE_DIGIT PW_REQUIRE_UPPER PW_REQUIRE_SPECIAL

      mkdir -p /var/lib/dozilab
      echo "multiuser setup started $(date -Is)" > "$LOG"

      # --- pwquality.conf ---
      to_bool() {
        local v="${1:-}"
        v="$(echo "$v" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"
        [[ "$v" == "1" || "$v" == "true" || "$v" == "yes" || "$v" == "on" ]]
      }

      DCREDIT=0
      UCREDIT=0
      OCREDIT=0
      if to_bool "$PW_REQUIRE_DIGIT"; then DCREDIT=-1; fi
      if to_bool "$PW_REQUIRE_UPPER"; then UCREDIT=-1; fi
      if to_bool "$PW_REQUIRE_SPECIAL"; then OCREDIT=-1; fi
      if ! [[ "$PW_MIN_LENGTH" =~ ^[0-9]+$ ]]; then PW_MIN_LENGTH=12; fi

      cat >/etc/security/pwquality.conf <<EOF
      # Managed by DoziLab (cloud-init)
      minlen = ${PW_MIN_LENGTH}
      dcredit = ${DCREDIT}
      ucredit = ${UCREDIT}
      ocredit = ${OCREDIT}
      EOF

      # Ensure pam_pwquality active (and enforce_for_root so chpasswd is checked)
      PAM_FILE="/etc/pam.d/common-password"
      if grep -qE 'pam_pwquality\.so' "$PAM_FILE"; then
        if ! grep -qE 'pam_pwquality\.so.*\bretry=' "$PAM_FILE"; then
          sed -i -E '/pam_pwquality\.so/ s/$/ retry=3/' "$PAM_FILE"
        fi
        if ! grep -qE 'pam_pwquality\.so.*\benforce_for_root\b' "$PAM_FILE"; then
          sed -i -E '/pam_pwquality\.so/ s/$/ enforce_for_root/' "$PAM_FILE"
        fi
      else
        sed -i -E '/^\s*password\s+.*pam_unix\.so/ i password requisite pam_pwquality.so retry=3 enforce_for_root' "$PAM_FILE"
      fi

      # SSH: enable password login
      cat >/etc/ssh/sshd_config.d/99-dozilab-multiuser.conf <<'EOF'
      PasswordAuthentication yes
      KbdInteractiveAuthentication yes
      ChallengeResponseAuthentication yes
      UsePAM yes
      PermitRootLogin no
      EOF

      # Create students
      python3 - <<'PY'
      import json, os, re, sys, subprocess

      students_json = os.environ.get("STUDENTS_JSON", "")
      force = str(os.environ.get("FORCE", "true")).lower() in ("1","true","yes","on")
      workdir = os.environ.get("WORKDIR","work")

      data = json.loads(students_json)
      if not isinstance(data, dict) or not data:
          sys.exit("students must be a non-empty JSON object")

      rx = re.compile(r"^[a-z_][a-z0-9_-]{0,31}$")

      def run(cmd, **kw):
          subprocess.run(cmd, check=True, **kw)

      for u, p in data.items():
          if not isinstance(u, str) or not rx.match(u):
              sys.exit(f"Invalid username: {u!r}")
          if not isinstance(p, str) or len(p) == 0:
              sys.exit(f"Empty password for {u}")

          if subprocess.run(["id", u], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL).returncode != 0:
              run(["useradd", "-m", "-s", "/bin/bash", u])

          run(["chpasswd"], input=f"{u}:{p}\n", text=True)

          if force:
              subprocess.run(["chage", "-d", "0", u], check=False)

          run(["chmod", "700", f"/home/{u}"])
          run(["mkdir", "-p", f"/home/{u}/{workdir}"])
          run(["chown", "-R", f"{u}:{u}", f"/home/{u}/{workdir}"])
          run(["chmod", "700", f"/home/{u}/{workdir}"])

          profile = f"/home/{u}/.profile"
          line = f'cd "$HOME/{workdir}"\n'
          try:
              txt = open(profile, "r", encoding="utf-8", errors="ignore").read()
          except FileNotFoundError:
              txt = ""
          if f'cd "$HOME/{workdir}"' not in txt:
              with open(profile, "a", encoding="utf-8") as f:
                  f.write(line)
          run(["chown", f"{u}:{u}", profile])

      allow = "AllowUsers ubuntu " + " ".join(sorted(data.keys())) + "\n"
      with open("/etc/ssh/sshd_config.d/98-dozilab-allowusers.conf", "w", encoding="utf-8") as f:
          f.write(allow)
      PY

      systemctl restart ssh || service ssh restart

      echo "multiuser setup finished $(date -Is)" >> "$LOG"

      # READY marker: write a file + write to the VM console (Nova console log)
      echo "DOZILAB_READY stack=${STACK_LABEL} time=$(date -Is)" | tee -a "$LOG" | tee /dev/console > "$MARK_FILE"
      chmod 644 "$MARK_FILE"

runcmd:
  - [ bash, -lc, "/usr/local/bin/dozilab-multiuser-setup.sh" ]

final_message: "DoziLab multi-user VM ready (password SSH enabled + PAM pwquality policy)"
