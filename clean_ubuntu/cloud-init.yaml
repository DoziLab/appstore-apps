#cloud-config
package_update: true
package_upgrade: false

write_files:
  - path: /usr/local/bin/dozilab-multiuser-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      STUDENTS_JSON='__STUDENTS_JSON__'
      FORCE="__FORCE_CHANGE__"
      WORKDIR="__WORKDIR__"

      export STUDENTS_JSON FORCE WORKDIR

      echo "multiuser setup started $(date -Is)" > /var/log/dozilab-multiuser.log

      # --- 1) Force password auth on Ubuntu cloud image (source of truth) ---
      if [ -f /etc/ssh/sshd_config.d/60-cloudimg-settings.conf ]; then
        sed -i -E 's/^\s*PasswordAuthentication\s+no\s*$/PasswordAuthentication yes/i' \
          /etc/ssh/sshd_config.d/60-cloudimg-settings.conf

        if ! grep -qiE '^\s*PasswordAuthentication\s+' /etc/ssh/sshd_config.d/60-cloudimg-settings.conf; then
          echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
        fi
      fi

      cat >/etc/ssh/sshd_config.d/99-dozilab-multiuser.conf <<'EOF'
      PasswordAuthentication yes
      KbdInteractiveAuthentication yes
      ChallengeResponseAuthentication yes
      UsePAM yes
      PermitRootLogin no
      EOF

      # --- 2) Parse JSON mapping username -> password and create users ---
      python3 - <<'PY'
      import json, os, re, sys, subprocess

      students_json = os.environ.get("STUDENTS_JSON", "")
      force = os.environ.get("FORCE", "true").lower() in ("1", "true", "yes")
      workdir = os.environ.get("WORKDIR", "work")

      if not students_json.strip():
          print("students JSON is empty", file=sys.stderr)
          sys.exit(1)

      try:
          data = json.loads(students_json)
      except Exception as e:
          print(f"students JSON parse error: {e}", file=sys.stderr)
          sys.exit(1)

      if not isinstance(data, dict) or not data:
          print("students must be a non-empty JSON object: {username: password, ...}", file=sys.stderr)
          sys.exit(1)

      rx = re.compile(r"^[a-z_][a-z0-9_-]{0,31}$")

      def run(cmd):
          subprocess.run(cmd, check=True)

      for u, p in data.items():
          if not isinstance(u, str) or not rx.match(u):
              print(f"Invalid username: {u!r}", file=sys.stderr)
              sys.exit(1)
          if not isinstance(p, str) or len(p) < 8:
              print(f"Password too short for {u}", file=sys.stderr)
              sys.exit(1)

          # create user (id returns non-zero if missing)
          if subprocess.run(["id", u], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL).returncode != 0:
              run(["useradd", "-m", "-s", "/bin/bash", u])

          # set password safely (no shell quoting issues)
          subprocess.run(["chpasswd"], input=f"{u}:{p}\n", text=True, check=True)

          if force:
              subprocess.run(["chage", "-d", "0", u], check=False)

          # lock down home
          run(["chmod", "700", f"/home/{u}"])

          # workdir + permissions
          run(["mkdir", "-p", f"/home/{u}/{workdir}"])
          run(["chown", "-R", f"{u}:{u}", f"/home/{u}/{workdir}"])
          run(["chmod", "700", f"/home/{u}/{workdir}"])

          # land in workdir on login
          profile = f"/home/{u}/.profile"
          line = f'cd "$HOME/{workdir}"\n'
          try:
              with open(profile, "r", encoding="utf-8", errors="ignore") as f:
                  txt = f.read()
          except FileNotFoundError:
              txt = ""
          if f'cd "$HOME/{workdir}"' not in txt:
              with open(profile, "a", encoding="utf-8") as f:
                  f.write(line)
          run(["chown", f"{u}:{u}", profile])

      # AllowUsers ubuntu + all students
      allow = "AllowUsers ubuntu " + " ".join(sorted(data.keys())) + "\n"
      with open("/etc/ssh/sshd_config.d/98-dozilab-allowusers.conf", "w", encoding="utf-8") as f:
          f.write(allow)
      PY

      systemctl restart ssh
      echo "multiuser setup finished $(date -Is)" >> /var/log/dozilab-multiuser.log

runcmd:
  - [ bash, -lc, "/usr/local/bin/dozilab-multiuser-setup.sh" ]

final_message: "DoziLab multi-user VM ready (password SSH enabled)"
