#cloud-config
package_update: true
package_upgrade: false

write_files:
  - path: /usr/local/bin/dozilab-multiuser-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      STUDENTS_JSON='__STUDENTS_JSON__'
      FORCE="__FORCE_CHANGE__"
      WORKDIR="__WORKDIR__"

      PW_MIN_LENGTH="__PW_MIN_LENGTH__"
      PW_REQUIRE_DIGIT="__PW_REQUIRE_DIGIT__"
      PW_REQUIRE_UPPER="__PW_REQUIRE_UPPER__"
      PW_REQUIRE_SPECIAL="__PW_REQUIRE_SPECIAL__"

      export STUDENTS_JSON FORCE WORKDIR
      export PW_MIN_LENGTH PW_REQUIRE_DIGIT PW_REQUIRE_UPPER PW_REQUIRE_SPECIAL

      echo "multiuser setup started $(date -Is)" > /var/log/dozilab-multiuser.log

      # --- 0) Install pwquality (PAM password policy) ---
      export DEBIAN_FRONTEND=noninteractive
      apt-get update -y
      apt-get install -y libpam-pwquality

      # --- 0.1) Render /etc/security/pwquality.conf from Heat params ---
      # pwquality credits:
      #  - negative => require that many chars of the class
      #  - zero/positive => do not require (or "credit" behaviour)
      to_bool() {
        local v="${1:-}"
        v="$(echo "$v" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"
        [[ "$v" == "1" || "$v" == "true" || "$v" == "yes" || "$v" == "on" ]]
      }

      DCREDIT=0
      UCREDIT=0
      OCREDIT=0

      if to_bool "$PW_REQUIRE_DIGIT"; then DCREDIT=-1; fi
      if to_bool "$PW_REQUIRE_UPPER"; then UCREDIT=-1; fi
      if to_bool "$PW_REQUIRE_SPECIAL"; then OCREDIT=-1; fi

      # Basic sanity for min length
      if ! [[ "$PW_MIN_LENGTH" =~ ^[0-9]+$ ]]; then
        PW_MIN_LENGTH=12
      fi

      cat >/etc/security/pwquality.conf <<EOF
      # Managed by DoziLab (cloud-init)
      #
      # See: man pwquality.conf, man pam_pwquality
      #
      minlen = ${PW_MIN_LENGTH}
      dcredit = ${DCREDIT}
      ucredit = ${UCREDIT}
      ocredit = ${OCREDIT}
      # lcredit = 0   # not required (can be set to -1 if you also want lowercase)
      #
      # Optional nice defaults (commented):
      # difok = 1
      # maxrepeat = 3
      # maxclassrepeat = 4
      EOF

      # --- 0.2) Ensure PAM uses pam_pwquality and enforces it also when root sets passwords (chpasswd runs as root) ---
      PAM_FILE="/etc/pam.d/common-password"

      if grep -qE 'pam_pwquality\.so' "$PAM_FILE"; then
        # ensure retry=3 exists
        if ! grep -qE 'pam_pwquality\.so.*\bretry=' "$PAM_FILE"; then
          sed -i -E '/pam_pwquality\.so/ s/$/ retry=3/' "$PAM_FILE"
        fi
        # ensure enforce_for_root exists
        if ! grep -qE 'pam_pwquality\.so.*\benforce_for_root\b' "$PAM_FILE"; then
          sed -i -E '/pam_pwquality\.so/ s/$/ enforce_for_root/' "$PAM_FILE"
        fi
      else
        # insert before pam_unix password line
        sed -i -E '/^\s*password\s+.*pam_unix\.so/ i password requisite pam_pwquality.so retry=3 enforce_for_root' "$PAM_FILE"
      fi

      # --- 1) Force password auth on Ubuntu cloud image (source of truth) ---
      if [ -f /etc/ssh/sshd_config.d/60-cloudimg-settings.conf ]; then
        sed -i -E 's/^\s*PasswordAuthentication\s+no\s*$/PasswordAuthentication yes/i' \
          /etc/ssh/sshd_config.d/60-cloudimg-settings.conf

        if ! grep -qiE '^\s*PasswordAuthentication\s+' /etc/ssh/sshd_config.d/60-cloudimg-settings.conf; then
          echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
        fi
      fi

      cat >/etc/ssh/sshd_config.d/99-dozilab-multiuser.conf <<'EOF'
      PasswordAuthentication yes
      KbdInteractiveAuthentication yes
      ChallengeResponseAuthentication yes
      UsePAM yes
      PermitRootLogin no
      EOF

      # --- 2) Parse JSON mapping username -> password and create users ---
      # NOTE: Password policy is enforced by PAM/pwquality during `chpasswd`.
      python3 - <<'PY'
      import json, os, re, sys, subprocess

      students_json = os.environ.get("STUDENTS_JSON", "")
      force = str(os.environ.get("FORCE", "true")).lower() in ("1", "true", "yes", "on")
      workdir = os.environ.get("WORKDIR", "work")

      if not students_json.strip():
          print("students JSON is empty", file=sys.stderr)
          sys.exit(1)

      try:
          data = json.loads(students_json)
      except Exception as e:
          print(f"students JSON parse error: {e}", file=sys.stderr)
          sys.exit(1)

      if not isinstance(data, dict) or not data:
          print("students must be a non-empty JSON object: {username: password, ...}", file=sys.stderr)
          sys.exit(1)

      rx = re.compile(r"^[a-z_][a-z0-9_-]{0,31}$")

      def run(cmd):
          subprocess.run(cmd, check=True)

      for u, p in data.items():
          if not isinstance(u, str) or not rx.match(u):
              print(f"Invalid username: {u!r}", file=sys.stderr)
              sys.exit(1)
          if not isinstance(p, str) or len(p) == 0:
              print(f"Password must be a non-empty string for {u}", file=sys.stderr)
              sys.exit(1)

          # create user if missing
          if subprocess.run(["id", u], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL).returncode != 0:
              run(["useradd", "-m", "-s", "/bin/bash", u])

          # set password via PAM (pwquality). If policy fails, chpasswd exits non-zero.
          subprocess.run(["chpasswd"], input=f"{u}:{p}\n", text=True, check=True)

          if force:
              subprocess.run(["chage", "-d", "0", u], check=False)

          # lock down home
          run(["chmod", "700", f"/home/{u}"])

          # workdir + permissions
          run(["mkdir", "-p", f"/home/{u}/{workdir}"])
          run(["chown", "-R", f"{u}:{u}", f"/home/{u}/{workdir}"])
          run(["chmod", "700", f"/home/{u}/{workdir}"])

          # land in workdir on login
          profile = f"/home/{u}/.profile"
          line = f'cd "$HOME/{workdir}"\n'
          try:
              with open(profile, "r", encoding="utf-8", errors="ignore") as f:
                  txt = f.read()
          except FileNotFoundError:
              txt = ""
          if f'cd "$HOME/{workdir}"' not in txt:
              with open(profile, "a", encoding="utf-8") as f:
                  f.write(line)
          run(["chown", f"{u}:{u}", profile])

      # AllowUsers ubuntu + all students
      allow = "AllowUsers ubuntu " + " ".join(sorted(data.keys())) + "\n"
      with open("/etc/ssh/sshd_config.d/98-dozilab-allowusers.conf", "w", encoding="utf-8") as f:
          f.write(allow)
      PY

      systemctl restart ssh
      echo "multiuser setup finished $(date -Is)" >> /var/log/dozilab-multiuser.log

runcmd:
  - [ bash, -lc, "/usr/local/bin/dozilab-multiuser-setup.sh" ]

final_message: "DoziLab multi-user VM ready (password SSH enabled + PAM pwquality policy)"
