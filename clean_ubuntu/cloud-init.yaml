#cloud-config
package_update: true
package_upgrade: false

packages:
  - nginx

write_files:
  # Our SSH settings (some keys can be overridden, but keep them here)
  - path: /etc/ssh/sshd_config.d/99-dozilab-ssh.conf
    permissions: "0644"
    content: |
      # DoziLab: allow password logins for student accounts (cloud image may disable it)
      PasswordAuthentication yes
      KbdInteractiveAuthentication yes
      ChallengeResponseAuthentication yes
      UsePAM yes
      PermitRootLogin no

  - path: /usr/local/bin/dozilab-student-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      TITLE="__PAGE_TITLE__"
      LABEL="__STACK_LABEL__"
      U="__STUDENT_USER__"
      P="__STUDENT_PASS__"
      FORCE="__FORCE_CHANGE__"
      WORKDIR="__WORKDIR__"

      echo "setup started $(date -Is)" > /var/log/dozilab-student-setup.log

      # Create student user (no sudo)
      if ! id "$U" >/dev/null 2>&1; then
        useradd -m -s /bin/bash "$U"
      fi

      # Set student password (do not echo it anywhere)
      echo "${U}:${P}" | chpasswd

      # Force password change on first login (optional)
      if [ "$FORCE" = "True" ] || [ "$FORCE" = "true" ] || [ "$FORCE" = "1" ]; then
        chage -d 0 "$U" || true
      fi

      # Restrict home + workdir to the student only
      chmod 700 "/home/${U}"
      mkdir -p "/home/${U}/${WORKDIR}"
      chown -R "${U}:${U}" "/home/${U}/${WORKDIR}"
      chmod 700 "/home/${U}/${WORKDIR}"

      # On login, land in ~/WORKDIR
      if ! grep -q "cd \"\$HOME/${WORKDIR}\"" "/home/${U}/.profile" 2>/dev/null; then
        echo "cd \"\$HOME/${WORKDIR}\"" >> "/home/${U}/.profile"
      fi
      chown "${U}:${U}" "/home/${U}/.profile"

      # OPTIONAL: restrict SSH logins to ubuntu + student only
      # (helps reduce brute-force surface)
      if [ ! -f /etc/ssh/sshd_config.d/98-dozilab-allowusers.conf ]; then
        cat >/etc/ssh/sshd_config.d/98-dozilab-allowusers.conf <<EOF
      AllowUsers ubuntu ${U}
      EOF
      fi

      # CRITICAL: Ubuntu cloud images often ship:
      # /etc/ssh/sshd_config.d/60-cloudimg-settings.conf: PasswordAuthentication no
      # which may "win" in your environment. Patch it directly.
      if [ -f /etc/ssh/sshd_config.d/60-cloudimg-settings.conf ]; then
        # Replace "no" -> "yes" (case-insensitive, safe if already yes)
        sed -i -E 's/^\s*PasswordAuthentication\s+no\s*$/PasswordAuthentication yes/i' \
          /etc/ssh/sshd_config.d/60-cloudimg-settings.conf

        # If the line does not exist (unlikely), append it
        if ! grep -qiE '^\s*PasswordAuthentication\s+' /etc/ssh/sshd_config.d/60-cloudimg-settings.conf; then
          echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
        fi
      fi

      # Restart SSH to apply config
      systemctl restart ssh

      # Simple optional dashboard
      PRIVATE_IP="$(hostname -I | awk '{print $1}')"
      HOST="$(hostname)"
      DEPLOY_TIME="$(date -Is)"
      cat >/var/www/html/index.html <<HTML
      <!doctype html>
      <html lang="de"><head><meta charset="utf-8"><title>${TITLE}</title></head>
      <body style="font-family:system-ui;margin:24px">
        <h1>${TITLE}</h1>
        <p><b>Stack:</b> ${LABEL}</p>
        <p><b>Host:</b> ${HOST}</p>
        <p><b>Private IP:</b> ${PRIVATE_IP}</p>
        <p><b>Deployed:</b> ${DEPLOY_TIME}</p>
        <p><b>Student user:</b> <code>${U}</code> (lands in <code>~/${WORKDIR}</code>)</p>
      </body></html>
      HTML
      systemctl enable --now nginx

      echo "setup finished $(date -Is)" >> /var/log/dozilab-student-setup.log

runcmd:
  - [ bash, -lc, "/usr/local/bin/dozilab-student-setup.sh" ]

final_message: "DoziLab Student VM ready (password SSH enabled)"
